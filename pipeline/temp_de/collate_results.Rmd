---
title: "Temperature differential expression collation"
author: "Kieran R Campbell"
output:
  html_document: 
    toc: true
    toc_float: true
  html_notebook: default
params:
  comparison: 1
  design_file: design.csv
  output_rds: output.rds
---


```{r}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE)

suppressPackageStartupMessages({
  library(scater)
  library(SingleCellExperiment)
  library(tidyverse)
  library(glue)
  library(edgeR)
  library(limma)
  library(ggrepel)
})
```


```{r}
rds_files <- dir("../../data/temp_de/", full.names = TRUE, pattern="rds$")

df_de <- map_df(rds_files, readRDS)
```

```{r}
df_de <- mutate(df_de, is_hsp = grepl("^HSP", gene_symbol))
```



```{r}

mapping = c(
  "1"="SA854 (MDA-MB-231 TNBC cell line)",
  "2"="SA604X9XB2413 (TNBC PDX)",
  "3"="SA604X9XB2417 (TNBC PDX)",
  "4"="SA604X6 (TNBC PDX)",
  "5"="VOA11019SA (HGSC Ovarian patient sample)",
  "6"="SA604X8XB02164 (TNBC PDX)"
)

custom_cols <- c(
  "Heat shock protein gene"="darkred",
  "Mitochondrial gene"="darkblue"
)

df_de$gene_type <- NA
df_de$gene_type[grepl("^HSP", df_de$gene_symbol)] <- "Heat shock protein gene"
df_de$gene_type[grepl("^MT-", df_de$gene_symbol)] <- "Mitochondrial gene"

df_de$description <- plyr::mapvalues(df_de$comparison, from = names(mapping), to = mapping)

gene_df <- filter(df_de, !is.na(gene_type))

df_text <- group_by(df_de, comparison) %>% 
  top_n(25, desc(qval))

ggplot(df_de, aes(x = log2foldchange, y = -log10(qval))) +
  geom_point(colour = "grey60") +
  geom_point(data = gene_df, aes(colour = gene_type)) +
  geom_text_repel(data = df_text, aes(label = gene_symbol), size = 2.7) +
  facet_wrap(~ description, scales = "free") +
  labs(x = expression(log[2]~(fold~change)~"37C vs 6C"),
       y = expression(-log[10](q-value))) +
  scale_color_manual(values=custom_cols) +
  theme_bw() +
  theme(legend.title = element_blank(), 
        legend.position = "bottom",
        strip.background = element_rect(fill = 'grey95'),
        legend.text = element_text(size = 11),
        legend.box.background = element_rect(linetype = 1, size = 1)) 

```

```{r}
ggsave("../../figs/temp_figure_1.png", width = 12, height = 7)
```


```{r}
lfc_df <- dplyr::select(gene_df, gene_symbol, gene_type, log2foldchange, description) %>% 
  spread(description, log2foldchange)

pairs <- t(combn(mapping, 2))

plots <- lapply(seq_len(nrow(pairs)), function(i) {
  samples <- pairs[i,]
  d <- dplyr::select(lfc_df, gene_symbol, gene_type, contains(samples[1]), contains(samples[2]))
  
  names(d)[3:4] <- c("x", "y")
  
  ggplot(d, aes(x = x, y = y, color = gene_type)) +
    geom_point() +
    labs(x = paste("log fold change", samples[1]),
         y = paste("log fold change", samples[2])) +
    theme_bw() +
    theme(legend.title = element_blank(),
          legend.position = "none",
          axis.title = element_text(size = 8)) +
    scale_colour_manual(values = custom_cols)
})

cowplot::plot_grid(plotlist = plots, nrow = 3)

ggsave("../../figs/hsp_response.png", width = 14, height = 10)
```

# GO analysis

```{r}

csv_files <- dir("../../data/temp_de_pathways/", full.names = TRUE, pattern="csv$")

df_pt <- map_df(csv_files, read_csv)
```



```{r}
df_pt$description <- plyr::mapvalues(df_pt$comparison, from = names(mapping), to = mapping)

text_df <- group_by(df_pt, description) %>% 
  top_n(10, desc(FDR)) %>% 
  ungroup()

ggplot(df_pt, aes(x = Direction, y = -log10(FDR))) +
  geom_text_repel(data = text_df, aes(label = pathway), size = 2) +
  geom_point(aes(colour = significant)) +
  facet_wrap(~ description, scales = "free_y") +
  scale_colour_manual(values = c("TRUE"="darkred", "FALSE"="grey70")) +
  labs(x = "Median log fold change", y = expression(-log[10](FDR)))

ggsave("../../figs/temperature_pathway_response.png", width = 10, height = 7)
```

## Maybe a different way of visualising?

```{r}
top_df <- text_df

ggplot(top_df, aes(x = pathway, y = -log10(FDR), fill = Direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ description, scales = "free_x") +
  coord_flip()
```

