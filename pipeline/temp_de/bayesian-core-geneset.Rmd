---
title: "Bayesian core geneset construction"
output: html_notebook
---

```{r}
suppressPackageStartupMessages({
  library(rstan)
  library(tidyverse)
})
```

```{r}
rds_files <- dir("../../data/temp_de/", full.names = TRUE, pattern="rds$")

df_de <- map_df(rds_files, readRDS)
```

```{r}
df_de <- count(df_de, ensembl_gene_id) %>% 
  dplyr::filter(n == 7) %>% 
  inner_join(df_de)
```


```{r, results='hide'}
model <- stan_model("coregene2.stan")
```

```{r}
logfcs <- select(df_de, gene_symbol, comparison, logFC) %>% 
  spread(gene_symbol, logFC) %>% 
  select(-comparison) %>% 
  as.matrix() %>% 
  t()

ses <- select(df_de, gene_symbol, comparison, se) %>% 
  spread(gene_symbol, se) %>% 
  select(-comparison) %>% 
  as.matrix() %>% 
  t()

logfcs[is.na(logfcs)] <- 10e5
ses[is.na(ses)] <- 10e5

is_missing <- 1 * (is.na(logfcs) & is.na(ses))

```

```{r}
data <- list(
  G = nrow(logfcs),
  E = ncol(logfcs),
  beta_obs = logfcs,
  beta_se = ses#,
  #is_missing = is_missing
)
```

```{r}
fit <- sampling(model, data, chains = 1)
```

```{r}
stan_hist(fit, 'phi')
stan_hist(fit, 'lambda[2]')
```

```{r}
s <- summary(fit)
s <- s$summary

s <- s[grepl("^beta", rownames(s)),]
```

```{r}
dfc <- as_tibble(s) %>% 
  mutate(gene = rownames(logfcs)) %>% 
  select(gene, everything())

dfc <- dplyr::rename(dfc, lower = `2.5%`, upper = `97.5%`)
```

```{r}
dfc_s <- filter(dfc, lower > 0 | upper < 0 )

dfc_s <- arrange(dfc_s, desc(mean))

gene_order <- dfc_s$gene
dfc_s$gene <- factor(dfc_s$gene, levels = rev(gene_order))
```



```{r}
ggplot(dfc_s, aes(x = mean, y = gene)) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), colour = 'grey50') +
  geom_point(aes(fill = mean), shape = 21, colour = 'black') +
  theme_bw(base_size = 10) +
  scale_fill_gradient2(low = scales::muted('blue'), high = scales::muted('red'), guide = FALSE) +
  labs(x = "Combined effect size (95% credible interval)", y = "Gene", subtitle = "Core heat response geneset") 

ggsave("../../figs/coregeneset.png", width = 4, height = 12)
```






